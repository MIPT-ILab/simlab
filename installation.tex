\chapter{Установка и лицензирование Simics} \label{chap:installation-notes}

В данное приложение включена информация по лицензированию и установке Simics в учебной лаборатории. Наиболее полная информация по данному вопросу содержится в документе «Simics Installation Guide»~\cite{installation}, который идёт в поставке со всеми пакетами Simics (файл \texttt{installation-guide.pdf}).

Приводимые ниже инструкции были собраны для Simics версии 4.6 для хозяйской системы Linux 64 бит, рекомендуемой для всех пользователей. Для ОС Linux 32 бит инструкции изменяются незначительно; для ОС Windows они применимы после учёта особенностей графического процесса инсталляции.

\section{Академическая программа Wind River Simics}

Компания Intel предлагает Simics бесплатно для некоммерческих исследований и обучения в выбранных университетах через академическую программу Intel Simics Academic Program. Для включения нового университета в эту программу необходимо согласие на поддержку начинания одного ментора --- сотрудника Intel. 

Дополнительная информация об истории и статусе академической программы Simics~\cite[engblom-academic-simics].

\subsection{Условия использования}

Использование Simics по академической программе должно строго соответствовать условиям соглашения, т.е. быть ограничено учебной и/или некоммерческой научно-исследовательской деятельностью. В случае возникновения необходимости проведения коммерческих исследований или разработок необходимо обратиться к представителям Wind River для получения нового соглашения и другого типа лицензии.

Держатель лицензии от участвующего университета обязан донести эту информацию до всех пользователей инсталляции и контролировать выполнение ими условий соглашения, в том числе с помощью административных и технических мер.

Подробные детали об условиях и ограничениях академической программы содержатся в Intel Academic SLA, поставляемом с копией Simics для университетов.

\section{Установка файлов и запрос лицензии}

\subsection{Пакеты}

Simics распространяется в формате пакетов --- набора файлов, реализующих одну или несколько типов моделируемых систем или функциональность самого симулятора. Каждый пакет имеет свой фиксированный номер. Пакет \textnumero 1000 --- это Simics Base, содержащий базовую функциональность симулятора. Все остальные пакеты являются дополнениями к нему.

Дистрибутив пакета --- это файл с именем вида \texttt{simics-pkg-1000-4.6.34-linux64.tar}.  Здесь 1000 --- номер пакета, 4.6.34 --- версия пакета, linux64 --- архитектура хозяйской системы. Каждый дистрибутив каждого пакета зашифрован собственным ключом, состоящим из 32 символов. Дистрибутивы и их ключи получите у спонсора вашей академической программы.

Для установки всех необходимых файлов выполняется следующая процедура. Часть команд может потребовать наличия прав администратора.

\begin{enumerate}
\item Разархивируйте все пакеты *.tar:
\begin{lstlisting}
$for f in simics-pkg-*.tar; do tar xf $f; done
\end{lstlisting}
\item В созданной директории \texttt{simics-4.6-install} запустите скрипт установки:
\begin{lstlisting}
$ cd simics-4.6-install
# ./install-simics.pl
\end{lstlisting} 
    
\item Введите ключи шифрования для каждого номера пакета, который планируется установить:
\begin{lstlisting}
-> Looking for Simics packages in current directory...
Enter a decryption key for package-1000-4.6.34-linux64.tar.gz.tf,
or Enter to [Abort]: [Ключ]
\end{lstlisting} 

\item На вопрос, какие из пакетов требуется установить, ответьте <<All packages>>:
\begin{lstlisting}
install-simics can install the following packages:
 Number  Name          Type    Version  Host     Package
   1     Simics-Base   simics  4.6.34   linux64  package-1000
   2     Eclipse       addon   4.6.16   linux64  package-1001
   3     All packages
Please enter the numbers of the packages you want to install, as in "1 4 3"
Package numbers, or Enter to [Abort]:  3
\end{lstlisting}
    
\item На вопрос о директории назначения введите абсолютный путь или оставьте значение по умолчанию:
\begin{lstlisting}
Enter a destination directory for installation, or Enter
for [/opt/simics]:  [Путь установки или Enter]
\end{lstlisting}

\item Подтвердите начало установки, выбрав <<y>>.

\item При введении правильных ключей дистрибутивы будут расшифрованы и установлены в указанную при установке директорию --- в ней должны появиться подпапки с файлами из пакетов Simics.
\begin{lstlisting}
-> Decrypting package-1000-4.6.34-linux64.tar.gz.tf
-> Testing package-1000-4.6.34-linux64.tar.gz
-> Installing package-1000-4.6.34-linux64.tar.gz
-> Decrypting package-1001-4.6.16-linux64.tar.gz.tf
-> Testing package-1001-4.6.16-linux64.tar.gz
-> Installing package-1001-4.6.16-linux64.tar.gz

===============================

install-simics has finished installing the packages and will now
configure them.

No previous Simics installation was found. If you wish to configure
the newly installed Simics from a previous installation not found by
this script, you can do so by running the 'addon-manager' script in
the Simics installation with the option --upgrade-from:
    ./bin/addon-manager --upgrade-from /previous/install/

install-simics has installed the following add-on package:
   Eclipse  4.6.16  /opt/simics/simics-eclipse-4.8.26
\end{lstlisting}

\item На вопрос о регистрации расширений (\abbr add-on) ответьте <<y>>:
\begin{lstlisting}
Do you wish to make these add-on packages available in
Simics-Base 4.6.34? (y, n) [y]:  y
\end{lstlisting}   
\end{enumerate}

После успешного завершения файлы Simics были скопированы на ваш диск. Следующий шаг --- получение лицензии для их запуска. Он описывается далее.

\subsection{Получение lmhostid}

Для получения файла лицензии необходимо сгенерировать и передать число, так называемый lmhostid

\paragraph{Об именовании сетевых интерфейсов.} На момент написания данного материала утилиты из состава Simics не поддерживали получение корректного lmhostid на системах, использующих схему «стабильного именования» сетевых интерфейсов. Вместо традиционных для Linux имён \texttt{eth0}, \texttt{eth1} и т.д. сетевым картам выдаются имена, зависящие от производителя и физического расположения в системе.

Для обеспечения правильного именования \todo. 

\begin{enumerate}
    \item Установите пакет \texttt{lsb-core} на системе. Для Debian и Ubuntu это выполняется командой 
    
    \texttt{\# apt-get install lsb-core}
         
    \item Для получения lmhostid на сервере, \textit{который будет использоваться для запуска демона лицензий}, выполните команду:
    
\begin{lstlisting}
$ /opt/simics/simics-4.6.34/flexnet/linux64/bin/lmutil lmhostid
lmutil - Copyright (c) 1989-2011 Flexera Software, Inc. All Rights Reserved.
The FlexNet host ID of this machine is ""602fe934a369 422fe934a36c ""
Only use ONE from the list of hostids.
\end{lstlisting}

Выданное число (в примере выше <<602fe934a369>>) --- это lmhostid. Если чисел выдано несколько, то используйте только одно из них.
    
\end{enumerate}


Возможные решения:



\todo{Команда}

\subsection{Заполнение заявки}




\section{Настройка сервера лицензий}


\subsection{Файл лицензии}

Получаемый от производителя файл лицензии --- это текстовый документ, содержащий информацию о сроке действия, ограничениях количества одновременно запускаемых копий и поддерживаемых расширениях приложения. Пример содержимого для начала этого файла:

\begin{lstlisting}
# Simics 4.6 licence for the Simics Academic Program
#
# University:        Moscow Institute of Physics and Technology
# Contact:           academic.contact@university.edu
# Sponsor:           sponsor.contact@sponsor.com
# Licensing Contact: licencing.contact@licencer.com
#
SERVER  lic.university.edu lmhostid
VENDOR simics /home/Incoming/simics-4.6/simics-4.6.100/flexnet/linux64/bin
#
FEATURE simics simics 4.6 28-feb-2014 50 BD47D265FA68 \
        VENDOR_STRING=intel;academic HOSTID=ANY BORROW TS_OK \
        SIGN="0441 6AFA 450C BDBE E4D7 E125 1042 EEFF 04B5 767A ABCD \
        5088 80DB D912 292E 4FD5 22DD 22D0 D55F 5B25 4818"
<...>
\end{lstlisting}

Не изменяйте никаких строчек этого файла, кроме имени сервера лицензий. Сохраните копию файла в надёжном месте. Запишите дату окончания действия лицензии для последующей своевременной инициации процедуры обновления.

\subsection{Запуск сервера}

\subsection{Проверка работоспособности}



\section{Расположение файлов и сервера лицензий при подключении по сети}

По умолчанию все файлы Simics размещаются в директории \texttt{/opt/simics}. Если необходимо обеспечить запуск симулятора на нескольких компьютерах, подсоединённых по сети, рекомендуется разместить эти файлы установки в файловой системе, доступной по сети, например, по протоколам NFS или CIFS. Таким образом, клиентские машины смогут переиспользовать структуру инсталляции без необходимости её копирования на локальные диски, что упростит поддержку и обновления. Настройка сетевой файловой системы выходит за рамки данного руководства; необходимую информацию можно найти, например, в~\cite{nfs}.

\subsection{Финальный вид инсталляции}

На рис.~\ref{fig:install-overview} приведена рекомендуемая схема соединения систем и расположения служб для работы Simics на всех компьютерах учебного класса или лаборатории. В данном примере сервер для запуска демона лицензий отделён от сервера общих файлов; на практике они могут быть одной и той же системой.

\begin{figure}[htbp]
\centering
\begin{tikzpicture}[>=latex, font=\small]
    
    \node[draw] (lic-file) {simics-00AA-2014.lic};
    \node[draw, below = 0.25cm of lic-file] (lmgrd) {lmgrd демон};
    \node[above = 0.25cm of lic-file] (lic-host) {lic.university.edu};
    \node[draw, fit = (lic-file) (lmgrd) (lic-host)] (lic-server) {};    
    
    \node[draw, below = 2cm of lic-server] (installation) {/opt/simics/...};
    \node[draw, below = 0.25cm of installation] (nfs) {NFS демон};
    \node[above = 0.25cm of installation] (nfs-host) {nfs.university.edu};
    \node[draw, fit = (installation) (nfs) (nfs-host)] (nfs-server) {};
    
    \node[draw, right = 3cm of lic-file] (simics01) {Симуляция};
    \node[draw, below = 0.25cm of simics01] (lab01-client) {Клиент Simics};
    \node[above = 0.25cm of simics01] (lab01-host) {lab01.university.edu};
    \node[draw, fit = (simics01) (lab01-client) (lab01-host)] (lab01) {};

    \node[draw, below = 1.5cm of lab01] (simics02) {Симуляция};
    \node[draw, below = 0.25cm of simics02] (lab02-client) {Клиент Simics};
    \node[above = 0.25cm of simics02] (lab02-host) {lab02.university.edu};
    \node[draw, fit = (simics02) (lab02-client) (lab02-host)] (lab02) {};

    \node[draw, below = 1.5cm of lab02] (simics03) {Симуляция};
    \node[draw, below = 0.25cm of simics03] (lab03-client) {Клиент Simics};
    \node[above = 0.25cm of simics03] (lab03-host) {lab03.university.edu};
    \node[draw, fit = (simics03) (lab03-client) (lab03-host)] (lab03) {};
    
    \draw[->] (lmgrd.east) -- (lab01-client.west);
    \draw[->] (lmgrd.east) -- (lab02-client.west);
    \draw[->] (lmgrd.east) -- (lab03-client.west);
    
    \coordinate[right = 1cm of installation]  (midpoint);
    \draw[<-] (installation) -| (midpoint);
    \draw[->] (midpoint) |- (simics01);
    \draw[->] (midpoint) |- (simics02);
    \draw[->] (midpoint) |- (simics03);
    
\end{tikzpicture}
\caption{Расположение и функции узлов инсталляции Simics}\label{fig:install-overview}
\end{figure}


\subsection{Решение возникших проблем}

\begin{description}
    \item[Невозможно стартовать lmgrd]
    
    \item[Невозможно запустить Simics]
    
    \item[Нет подключения к демону лицензии с сервера]

    
    \item[Нет подключения к демону лицензии по сети] 
    
    \item[Демон лицензий не работает после перезагрузки сервера] 
    
    
    \item[Исчерпано число лицензий]
    
\end{description}

\section{Обновление пакетов существующей инсталляции}

\todo

\iftoggle{webpaper}{
    \printbibliography[title={Литература}]
}{}

